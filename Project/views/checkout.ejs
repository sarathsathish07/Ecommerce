<%- include('userheader') %>
<!-- Header Section End -->

<!-- Breadcrumb Section Begin -->
<section class="breadcrumb-option">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="breadcrumb__text">
          <h4>Check Out</h4>
          <div class="breadcrumb__links">
            <a href="/">Home</a>
            <a href="/shop">Shop</a>
            <span>Check Out</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- Breadcrumb Section End -->

<!-- Checkout Section Begin -->
<section class="checkout spad">
  <div class="container">
    <div class="checkout__form">
      <form action="/place-order" method="post">
        <div class="row">
          <div class="col-lg-8 col-md-6">
            <h6 class="checkout__title">Billing Details</h6>
            <div class="row">
              <div class="col-lg-12">
                <div class="checkout__input">
                  <p>Name: <%= user.name || '' %></p>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-lg-6">
                <div class="checkout__input">
                  <p>Phone: <%= user.phone || '' %></p>
                  <p>Email: <%= user.email || '' %></p>
                </div>
              </div>
            </div>

            <!-- Address Fields -->
            <div class="row">
              <div class="col-lg-12">
                <h6 class="checkout__title">Select Address</h6>
                <div class="checkout__input">
                  <% if (addresses && addresses.addresses &&
                  addresses.addresses.length > 0) { %>
                  <ul>
                    <% addresses.addresses.forEach((address, index) => { %>
                    <li>
                      <input type="radio" name="addressID" value="<%=
                      address._id %>"
                      onclick="setDefaultAddress('<%=address._id%>')" <%=
                      address.isDefault ? 'checked' : ''%>>
                      <p>
                        <%= address.addressLine1 %>, <%= address.addressLine2 %>
                      </p>
                      <p><%= address.city %>, <%= address.state %></p>
                      <p><%= address.country %> - <%= address.postalCode %></p>
                    </li>
                    <% }); %>
                  </ul>

                  <% } else { %>
                  <p>No existing addresses found.</p>
                  <% } %>
                </div>
                <section id="add-address" class="account-section">
  <button
    onclick="window.location.href='/addAddress?from=checkout'"
    style="
      background-color: #1f4959;
      color: white;
      padding-left: 10px;
      padding-right: 10px;
    "
  >
    Add Address
  </button>
</section>

              </div>
            </div>
          </div>
          <div class="col-lg-4 col-md-6">
            <div class="checkout__order">
              <h4 class="order__title">Your order</h4>
              <div class="checkout__order__products">
                Product <span>Total</span>
              </div>
              <ul class="checkout__total__products">
                <% for (let i = 0; i < cartItems.length; i++) { %>
                <li>
                  <%= i + 1 %>. <%= cartItems[i].product.productTitle %>
                  <span
                    >Rs <%= cartItems[i].price * cartItems[i].quantity %></span>
                </li>
                <% } %>
              </ul>
              <ul class="checkout__total__all">
                <li>Total (Excluding Delivery): <span>Rs <%= totalPrice %></span></li>
                <li>Delivery Charge: <span>Rs 100</span></li>
                <li>Total (Including Delivery): <span>Rs <%= totalPrice + 100 %></span></li>
              </ul>
              <div class="checkout__input__checkbox">
                <label for="payment-cod">
                  Cash on Delivery
                  <input
                    type="checkbox"
                    id="payment-cod"
                    name="paymentMethod"
                    value="Cash on Delivery"
                  />
                  <span class="checkmark"></span>
                  
                </label>
              </div>
              <div class="checkout__input__checkbox">
                <label for="payment-razorpay">
                  Razorpay
                  <input
                    type="checkbox"
                    id="payment-razorpay"
                    name="paymentMethod"
                    value="Razorpay"
                  />
                  <span class="checkmark"></span>
                  <span
                    id="check-error"
                    style="font-size: 14px; margin-top: -5px"
                  ></span>
                </label>
              </div>

              <% if (userAddress) { %>
              <input
                type="hidden"
                name="addressID"
                value="<%= userAddress._id %>"
              />
              <% } %>
              <input
                type="hidden"
                id="paymentStatus"
                name="paymentStatus"
              />
              <input
                type="hidden"
                name="cartItems"
                value="<%= JSON.stringify(cartItems) %>"
              />
              <input
                type="hidden"
                id="totalPrice"
                name="totalPrice"
                value="<%= totalPrice +100 %>"
              />
              <input type="hidden" name="orderId" value="<%= orderId %>">

              <button type="submit" class="site-btn">PLACE ORDER</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</section>

<footer class="footer">
  <div class="container">
    <div class="row">
      <div class="col-lg-3 col-md-6 col-sm-6">
        <div class="footer__about">
          <div class="footer__logo">
            <a href="#"><img src="img/footer-logo.png" alt="" /></a>
          </div>
          <p>
            The customer is at the heart of our unique business model, which
            includes design.
          </p>
          <a href="#"><img src="img/payment.png" alt="" /></a>
        </div>
      </div>
      <div class="col-lg-2 offset-lg-1 col-md-3 col-sm-6">
        <div class="footer__widget">
          <h6>Shopping</h6>
          <ul>
            <li><a href="#">Clothing Store</a></li>
            <li><a href="#">Trending Shoes</a></li>
            <li><a href="#">Accessories</a></li>
            <li><a href="#">Sale</a></li>
          </ul>
        </div>
      </div>
      <div class="col-lg-2 col-md-3 col-sm-6">
        <div class="footer__widget">
          <h6>Shopping</h6>
          <ul>
            <li><a href="#">Contact Us</a></li>
            <li><a href="#">Payment Methods</a></li>
            <li><a href="#">Delivary</a></li>
            <li><a href="#">Return & Exchanges</a></li>
          </ul>
        </div>
      </div>
      <div class="col-lg-3 offset-lg-1 col-md-6 col-sm-6">
        <div class="footer__widget">
          <h6>NewLetter</h6>
          <div class="footer__newslatter">
            <p>
              Be the first to know about new arrivals, look books, sales &
              promos!
            </p>
            <form action="#">
              <input type="text" placeholder="Your email" />
              <button type="submit"><span class="icon_mail_alt"></span></button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-12 text-center">
        <div class="footer__copyright__text">
          <p>
            Copyright Â©
            <script>
              document.write(new Date().getFullYear());
            </script>
            2020 All rights reserved | This template is made with
            <i class="fa fa-heart-o" aria-hidden="true"></i> by
            <a href="https://colorlib.com" target="_blank">Colorlib</a>
          </p>
        </div>
      </div>
    </div>
  </div>
</footer>

<div class="search-model">
  <div class="h-100 d-flex align-items-center justify-content-center">
    <div class="search-close-switch">+</div>
    <form class="search-model-form">
      <input type="text" id="search-input" placeholder="Search here....." />
    </form>
  </div>
</div>

<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script>
  var checkError = document.getElementById("check-error");

  function validateForm() {
  const paymentCODCheckbox = document.getElementById("payment-cod");
  const paymentRazorpayCheckbox = document.getElementById("payment-razorpay");
  const paymentStatusInput = document.getElementById("paymentStatus");

  const totalPriceInput = document.getElementById("totalPrice");
  const totalPrice = totalPriceInput ? parseInt(totalPriceInput.value) : 0;

  if (totalPrice > 1000 && paymentCODCheckbox.checked) {
    paymentStatusInput.value = "Pending";
    checkError.style.display = "block";
    checkError.innerHTML = "COD is not available for orders above Rs 1000.";
    checkError.style.color = "red";
    setTimeout(function () {
      checkError.style.display = "none";
    }, 3000);
    return false;
  } else if (!paymentCODCheckbox.checked && !paymentRazorpayCheckbox.checked) {
    checkError.style.display = "block";
    checkError.innerHTML = "Please select a payment method";
    checkError.style.color = "red";
    setTimeout(function () {
      checkError.style.display = "none";
    }, 3000);
    return false;
  } else if (paymentRazorpayCheckbox.checked) {
    initiateRazorpayPayment();
    return false;
    } else if (paymentCODCheckbox.checked) {
      paymentStatusInput.value = "Pending";
      Swal.fire({
        title: "Are you sure?",
        text: "Do you want to place the order?",
        icon: "question",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, place order",
      }).then((result) => {
        if (result.isConfirmed) {
          console.log("Order placed");
          document.querySelector("form").submit();
        }
      });
      return false;
    }
  }

  document.querySelector("form").addEventListener("submit", function (event) {
    event.preventDefault();

    validateForm();
  });
  

  function initiateRazorpayPayment() {
    const user = {
      name: "<%= user.name %>",
      email: "<%= user.email %>",
      phone: "<%= user.phone %>",
    };
    console.log(user);

    const totalPriceInput = document.getElementById("totalPrice");
    const totalPrice = totalPriceInput ? parseInt(totalPriceInput.value) : 0;

    var options = {
      key: "rzp_test_PkGwc5wn6qCei0",
      amount: totalPrice * 100,
      currency: "INR",
      name: "Your Company Name",
      description: "Purchase Description",
      image: "https://example.com/logo.png",
      
      handler: function (response) {
        console.log(response);
        if (response.razorpay_payment_id) {
          // Payment successful
          console.log("Payment successful");
          document.getElementById('paymentStatus').value = 'Paid';
        } else {
          // Payment failed or canceled
          console.log("Payment failed or canceled");
          document.getElementById('paymentStatus').value = 'Failed';
        }
        // Submit the form based on the payment status
        submitForm();
      },

      prefill: {
        name: user.name,
        email: user.email,
        contact: user.phone,
      },
      theme: {
        color: "#3399cc",
      },
    };

    var rzp = new Razorpay(options);

    rzp.on('payment.failed', function (response) {
      console.log("Payment failed:", response);
      // Handle payment failure here
      document.getElementById('paymentStatus').value = 'Failed';
      // Submit the form
      submitForm();
    });

    rzp.open();
  }

  function submitForm() {
    const form = document.querySelector("form");
    form.submit();
  }



</script>

<script>
  function setDefaultAddress(addressId) {
    fetch("/setDefaultAddress", {
      method: "POST",
      headers: {  
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ addressId }),
    })
      .then((response) => response.json())
      .then((data) => {
        console.log("Success:", data);
      })
      .catch((error) => {
        console.error("Error:", error);
      });
  }
</script>
<%- include('userfooter') %>
